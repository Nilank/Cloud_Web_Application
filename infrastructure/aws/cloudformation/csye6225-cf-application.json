{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description":"Cloud formation template to create application stack",
    "Parameters":{
      "NetworkStackNameParameter":{
        "Description":"Name of the Network Stack",
        "Type":"String"
      },
      "IAMPolicyStackNameParameter":{
        "Description":"Name of the IAM Policy Stack",
        "Type":"String"
      },

       "AMIid":{
        "Description":"AMI ID",
        "Type":"String"
      },
      "CodeDeployAppName":{
        "Default": "csye6225-webapp",
        "Description":"Code Deploy Application Name",
        "Type":"String"
      },

       "StackName":{
        "Description":"Application Stack Name",
        "Type":"String"
      },

      "KeyName":{
        "Description":"EC2 Key Name",
        "Type":"String"
      },

      "DBName":{
           "Default": "csye6225",
           "Description": "MySQL RDS DB Name",
           "Type": "String"
       },

       "DBAllocatedStorage" :{
           "Default": "5",
           "Description" : "The size of DB in GB",
           "Type": "Number"
       },
       "DBClass" : {
           "Default" : "db.t2.medium",
           "Description" : "Database instance class",
           "Type" : "String"
       },
       "DBUsername" : {
           "Default" : "csye6225master",
           "Description" : "The database admin account username",
           "Type": "String",
           "AllowedPattern" : "[a-zA-Z][a-zA-Z0-9]*"
       },
       "DBPassword" : {
           "Default": "csye6225password",
           "Description" : "The database admin account password",
           "Type": "String",
           "AllowedPattern" : "[a-zA-Z0-9]*"
       }
    },
    "Resources": {

      "webappSecurityGroup": {
        "Type" : "AWS::EC2::SecurityGroup",
        "Properties" : {
          "GroupDescription" : "rule to allow TCP traffic on port 22, 80 and 443 from anywhere in the world",
          "SecurityGroupIngress" : [ {
              "IpProtocol" : "tcp",
              "FromPort" : 22,
              "ToPort" : 22,
              "CidrIp" : "0.0.0.0/0"
            },
            {
              "IpProtocol" : "tcp",
              "FromPort" : 80,
              "ToPort" : 80,
              "CidrIp" : "0.0.0.0/0"
            },
            {
              "IpProtocol" : "tcp",
              "FromPort" : 443,
              "ToPort" : 443,
              "CidrIp" : "0.0.0.0/0"
            }
          ],
            "Tags" :  [ {
            "Key" : "Name",
            "Value" : {
              "Fn::Sub": [
                "${StackName}-csye6225-sgwebapp",
                {
                  "StackName": { "Ref": "StackName" }
                }
              ]
            }
            }
          ]
         ,
          "VpcId" :  {"Fn::ImportValue" : {"Fn::Sub" : "${NetworkStackNameParameter}-VpcID"}}
        }
      },

      "dbSecurityGroup": {
        "Type" : "AWS::EC2::SecurityGroup",
        "Properties" : {
          "GroupDescription" : "rule to allow TCP traffic on port 3306 for MySQL only from the webapp security group",
          "SecurityGroupIngress" : [ {
              "IpProtocol" : "tcp",
              "FromPort" : 3306,
              "ToPort" : 3306,
              "SourceSecurityGroupId" : { "Ref" : "webappSecurityGroup" }
            }
          ],

          "Tags" :  [ {
            "Key" : "Name",
            "Value" : {
              "Fn::Sub": [
                "${StackName}-csye6225-rdssg",
                {
                  "StackName": { "Ref": "StackName" }
                }
              ]
            }
            }
          ]

          ,
          "VpcId" :  {"Fn::ImportValue" : {"Fn::Sub" : "${NetworkStackNameParameter}-VpcID"}}
        }
      },

      "EC2Instance": {
        "Type" : "AWS::EC2::Instance",
        "Properties" : {
          "IamInstanceProfile" : {"Ref":"ec2InstanceProfile"},
          "ImageId" : {"Ref" : "AMIid" },
          "InstanceType" : "t2.micro",
          "KeyName" : {"Ref" : "KeyName" },
          "BlockDeviceMappings" : [
            {
               "DeviceName" : "/dev/sda1",
               "Ebs" : {
                 "DeleteOnTermination" : true,
                 "VolumeSize" : "20",
                 "VolumeType" : "gp2"
               }
            }
          ],
          "SecurityGroupIds": [
            { "Ref" : "webappSecurityGroup" }
          ],
          "SubnetId": {"Fn::ImportValue" : {"Fn::Sub" : "${NetworkStackNameParameter}-SubnetEC2"}},
          "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash -xe ",
                                "sudo touch /home/centos/setenv.sh",
                                "cd /home/centos",
                                {
                                    "Fn::Join": [
                                        "", [
                                            "echo 'JAVA_OPTS= -Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom -Dspring.datasource.username=csye6225master -Dspring.datasource.password=csye6225password -Dspring.profiles.active=dev -Dspring.datasource.url=jdbc:mysql://",
                                            {
                                                "Fn::GetAtt": [
                                                    "RDSInstance",
                                                    "Endpoint.Address"
                                                ]
                                            },
                                            ":3306/csye6225 -Dspring.bucket.name=csye6225-spring2019-surtia.me.csye6225.com",
                                            "\"' >> tomcat.service"
                                        ]
                                    ]
                                },
                                "sudo mv /home/centos/setenv.sh /opt/tomcat/bin"
                            ]
                        ]
                    }
                },
          "Tags" :  [ {
            "Key" : "Name",
            "Value" : {
              "Fn::Sub": [
                "${StackName}-csye6225-ec2",
                {
                  "StackName": { "Ref": "StackName" }
                }
              ]
            }
            }
          ]


        }
      },
      "DynamoDBTable": {
          "Type" : "AWS::DynamoDB::Table",
          "Properties" : {
          "AttributeDefinitions" : [
            {
            "AttributeName" : "id",
            "AttributeType" : "S"
            }
          ],
          "KeySchema" : [
            {
              "AttributeName" : "id",
              "KeyType" : "HASH"
            }
          ],
          "TableName" : "csye6225",
          "ProvisionedThroughput" : {
              "ReadCapacityUnits" : 5,
              "WriteCapacityUnits" : 5
            },
          "Tags" :  [ {
            "Key" : "Name",
            "Value" : {
              "Fn::Sub": [
                "${StackName}-csye6225-dynamodb",
                {
                  "StackName": { "Ref": "StackName" }
                }
              ]
            }
            }
          ]



        }
      },

  "DBSubnetGroup" : {
       "Type" : "AWS::RDS::DBSubnetGroup",
       "Properties" : {
       "DBSubnetGroupDescription" : "Subnets available for the RDS DB Instance",
       "SubnetIds" : [
                      {"Fn::ImportValue" : {"Fn::Sub" : "${NetworkStackNameParameter}-SubnetEC2"}},
                      {"Fn::ImportValue" : {"Fn::Sub" : "${NetworkStackNameParameter}-SubnetDB"}}  ],

        "Tags": [
            {
              "Key": "Name",
              "Value": {
              "Fn::Sub": [
                "${StackName}-csye6225-dbsubnetgrp",
                {
                  "StackName": { "Ref": "StackName" }
                }
              ]
            }
            }
          ]


      }
  },

  "RDSInstance": {
      "Type" : "AWS::RDS::DBInstance",
      "Properties" :
      {
          "DBName" : { "Ref" : "DBName"},
          "AllocatedStorage" : { "Ref" : "DBAllocatedStorage"},
          "DBInstanceClass" : { "Ref" : "DBClass"},
          "Engine" : "MySQL",
          "EngineVersion" : "5.6.35",
          "MasterUsername" : { "Ref" : "DBUsername"},
          "MasterUserPassword" : { "Ref" : "DBPassword"},
          "DBSubnetGroupName" : {"Ref" : "DBSubnetGroup"},
          "VPCSecurityGroups" : [ {"Ref" : "dbSecurityGroup" } ],
          "DBInstanceIdentifier" : "csye6225-spring2019",
          "MultiAZ" : false,
          "PubliclyAccessible" : true,

          "Tags": [
            {
              "Key": "Name",
              "Value": {
              "Fn::Sub": [
                "${StackName}-csye6225-rds",
                {
                  "StackName": { "Ref": "StackName" }
                }
                ]
              }
            }
          ]
        }
    },

    "codeDeployEC2ServiceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version" : "2012-10-17",
               "Statement": [ {
                  "Effect": "Allow",
                  "Principal": {
                     "Service": [ "ec2.amazonaws.com" ]
                  },
                  "Action": [ "sts:AssumeRole" ]
               } ]
         },
        "RoleName": "CodeDeployEC2ServiceRole"
      }
    },

    "CodeDeployEC2S3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyDocument" : {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Action": [
                      "s3:Get*",
                      "s3:List*"
                  ],
                  "Effect": "Allow",
                  "Resource": "*"
              }
          ]
        },
        "PolicyName" : "CodeDeploy-EC2-S3",
        "Roles": [ { "Ref": "codeDeployEC2ServiceRole" } ]
      }
    },

    "ec2InstanceProfile":{
       "Type": "AWS::IAM::InstanceProfile",
       "Properties": {
          "Roles": [ { "Ref": "codeDeployEC2ServiceRole" } ],
          "InstanceProfileName": "EC2InstanceProfile"
       }
    },

    "CodeDeployServiceRole" : {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version" : "2012-10-17",
               "Statement": [ {
                  "Effect": "Allow",
                  "Principal": {
                     "Service": [ "codedeploy.amazonaws.com" ]
                  },
                  "Action": [ "sts:AssumeRole" ]
               } ]
         },
         "ManagedPolicyArns": [ "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole" ],
        "RoleName": "CodeDeployServiceRole"
      }
    },

    "codeDeployApplication":{
      "Type" : "AWS::CodeDeploy::Application",
      "Properties" : {
        "ApplicationName" : {"Ref":"CodeDeployAppName"},
        "ComputePlatform" : "Server"
      }
    },

    "codeDeploymentGroup":{
      "Type" : "AWS::CodeDeploy::DeploymentGroup",
      "Properties" : {
        "ApplicationName" : {"Ref":"codeDeployApplication"},
        "AutoRollbackConfiguration" : {
            "Events" : [ "DEPLOYMENT_FAILURE" ]
          },
        "DeploymentGroupName" : "csye6225-webapp-deployment",
        "DeploymentConfigName" : "CodeDeployDefault.AllAtOnce",
        "DeploymentStyle" : {
          "DeploymentOption" : "WITHOUT_TRAFFIC_CONTROL",
          "DeploymentType" : "IN_PLACE"
        },
        "Ec2TagFilters":[
          {
            "Type" : "VALUE_ONLY",
            "Value" : "EC2-csye6225-ec2"
          }
          ],
        "ServiceRoleArn" : {
        "Fn::GetAtt": [
            "CodeDeployServiceRole",
            "Arn"
          ]
        }
      }
    }

    }
  }
